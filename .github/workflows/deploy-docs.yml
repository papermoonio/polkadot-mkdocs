name: Deploy Docs (Personal GH Pages)

on:
  workflow_dispatch:
    inputs:
      docs_branch:
        description: "Branch of 0xlukem/polkadot-docs to build"
        required: true
        default: "master"

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1) Checkout this repo (polkadot-mkdocs) so mkdocs.yml + requirements.txt are available
      - name: Checkout polkadot-mkdocs
        uses: actions/checkout@v4

      # 2) Checkout your docs fork into ./polkadot-docs
      - name: Checkout polkadot-docs (fork)
        uses: actions/checkout@v4
        with:
          repository: 0xlukem/polkadot-docs
          ref: ${{ inputs.docs_branch }}
          path: polkadot-docs

      # 3) Match Python to prod
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      # 4) Install the exact same requirements your repo uses

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Update image paths in Markdown files
        run: |
          # Match prod: rewrite absolute Markdown links for GitHub Pages subpath
          find polkadot-docs -type f -name "*.md" -exec sed -i -e 's|](/|](/polkadot-mkdocs/|g' -e 's|href="/|href="/polkadot-mkdocs/|g' {} \;

      - name: Configure Git identity for gh-deploy
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # 5) Deploy to gh-pages on YOUR fork (this repo) via mkdocs gh-deploy
      - name: Deploy to GitHub Pages (gh-pages branch)
        run: mkdocs gh-deploy --force --clean
